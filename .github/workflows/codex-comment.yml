---
name: Codex
on:
  issue_comment:
    types: [created]

concurrency:
  group: codex-${{ github.event.issue.number }}
  cancel-in-progress: true

jobs:
  check-team-member:
    name: Validate Codex commenter
    runs-on: ubuntu-latest
    if: |
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/codex') &&
      github.actor != 'github-actions[bot]'
    outputs:
      is-team-member: ${{ steps.check.outputs.is-member }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 1
      - name: Check if actor is on team
        id: check
        run: |
          ACTOR="${{ github.actor }}"
          if grep -q "@${ACTOR}" .github/teams.yml; then
            echo "is-member=true" >> "$GITHUB_OUTPUT"
            echo "✅ $ACTOR is a team member"
          else
            echo "is-member=false" >> "$GITHUB_OUTPUT"
            echo "❌ $ACTOR is not a team member"
          fi

  run-codex:
    name: Run Codex
    runs-on: ubuntu-latest
    needs: check-team-member
    if: |
      needs.check-team-member.result == 'success' &&
      needs.check-team-member.outputs.is-team-member == 'true'
    permissions:
      contents: read
    outputs:
      final_message: ${{ steps.codex.outputs.final-message }}
    steps:
      - name: Checkout PR merge commit
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: refs/pull/${{ github.event.issue.number }}/merge
      - name: Fetch base and head refs
        run: |
          git fetch --no-tags origin \
            ${{ github.event.issue.pull_request.base.ref }} \
            +refs/pull/${{ github.event.issue.number }}/head \
            +refs/pull/${{ github.event.issue.number }}/merge
      - name: Run Codex
        id: codex
        uses: openai/codex-action@v1
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          prompt: |
            You are Codex assisting on pull request #${{ github.event.issue.number }} in ${{ github.repository }}.

            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.issue.number }}
            BASE SHA: ${{ github.event.issue.pull_request.base.sha }}
            HEAD SHA: ${{ github.event.issue.pull_request.head.sha }}

            Comment from @${{ github.actor }}:
            ----
            ${{ github.event.comment.body }}
            ----

            Help the user with whatever they asked. If they're asking for a code review (e.g., "/codex /full-review", "/codex review this", or similar), follow the detailed review guidelines below. Otherwise, just help them with their question or request.

            ---
            CODE REVIEW GUIDELINES (use when reviewing PRs):

            Context:
            - Fetch additional context via:
              * gh pr view ${{ github.event.issue.number }} --json title,body,author,headRefName,baseRefName,commits
              * gh pr diff ${{ github.event.issue.number }} --name-only
            - Follow CLAUDE.md, AGENTS.md, and README conventions.
            - This is a Vite + React SPA using TanStack Query, React Router, Tailwind CSS, and TypeScript.
            - UI components should come from @zenml-io/react-component-library (never lucide-react).

            Primary Review Goals:
            1) Verify the change intent, edge cases, and regression risk.
            2) Enforce code quality: readability, hooks discipline, Query hygiene, router best practices.
            3) Validate accessibility, performance, and data-loading patterns.
            4) Ensure intentional diffs—no dead code, accidental assets, or config drift.
            5) Flag security or compatibility issues across supported ZenML versions.

            Documentation & Testing:
            - Cross-check docs (README, CLAUDE.md, AGENTS.md) when user flows/components change.
            - Confirm env vars and OpenAPI types are updated where applicable.
            - Testing (keep concise—avoid verbose or generic suggestions):
              * Only suggest tests directly relevant to the specific changes in this PR
              * For UI changes, suggest 1-2 specific manual testing steps
              * Do NOT recommend comprehensive test suites or patterns unrelated to the PR scope

            Output Instructions:
            - Start with a summary of what the PR achieves.
            - Enumerate critical blockers with file paths/lines.
            - Provide minor suggestions and highlight strong work.
            - End with actionable next steps.
            - Use `gh pr comment` for inline issues if needed.

  post-comment:
    name: Post Codex reply
    runs-on: ubuntu-latest
    needs: run-codex
    if: always() && needs.run-codex.result == 'success'
    permissions:
      issues: write
      pull-requests: write
    steps:
      - name: Debug outputs
        run: |
          echo "Final message length: ${#FINAL_MESSAGE}"
          echo "Issue number: ${{ github.event.issue.number }}"
        env:
          FINAL_MESSAGE: ${{ needs.run-codex.outputs.final_message }}
      - name: Reply with Codex output
        if: needs.run-codex.outputs.final_message
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const body = `${{ needs.run-codex.outputs.final_message }}`;
            if (!body || body.trim() === '') {
              core.info('No Codex output to post.');
              return;
            }
            console.log('Posting comment with length:', body.length);
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ github.event.issue.number }},
              body
            });
            console.log('Comment posted successfully');
