---
name: Codex Comment
on:
  issue_comment:
    types: [created]

concurrency:
  group: codex-${{ github.event.issue.number }}
  cancel-in-progress: true

jobs:
  check-team-member:
    name: Validate Codex commenter
    runs-on: ubuntu-latest
    if: |
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/codex') &&
      github.actor != 'github-actions[bot]'
    outputs:
      is-team-member: ${{ steps.check.outputs.is-member }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 1
      - name: Check if actor is on OSS team
        id: check
        run: |
          ACTOR="${{ github.actor }}"
          if grep -q "@${ACTOR}" .github/teams.yml; then
            echo "is-member=true" >> "$GITHUB_OUTPUT"
            echo "✅ $ACTOR is a team member"
          else
            echo "is-member=false" >> "$GITHUB_OUTPUT"
            echo "❌ $ACTOR is not a team member"
          fi

  run-codex:
    name: Run Codex
    runs-on: ubuntu-latest
    needs: check-team-member
    if: |
      needs.check-team-member.result == 'success' &&
      needs.check-team-member.outputs.is-team-member == 'true'
    permissions:
      contents: read
    outputs:
      final_message: ${{ steps.codex_comment.outputs.final-message || steps.codex_full_review.outputs.final-message }}
    steps:
      - name: Checkout PR merge commit
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: refs/pull/${{ github.event.issue.number }}/merge
      - name: Fetch base and head refs
        run: |
          git fetch --no-tags origin \
            ${{ github.event.issue.pull_request.base.ref }} \
            +refs/pull/${{ github.event.issue.number }}/head \
            +refs/pull/${{ github.event.issue.number }}/merge
      - name: Determine Codex mode
        id: mode
        run: |
          COMMENT="${{ github.event.comment.body }}"
          if echo "$COMMENT" | grep -qi '/codex /full-review'; then
            echo "mode=full-review" >> "$GITHUB_OUTPUT"
          else
            echo "mode=comment" >> "$GITHUB_OUTPUT"
          fi
      - name: Run Codex (quick reply)
        id: codex_comment
        if: steps.mode.outputs.mode == 'comment'
        uses: openai/codex-action@v1
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          prompt: |
            You are Codex assisting on pull request #${{ github.event.issue.number }} in ${{ github.repository }}.
            Base SHA: ${{ github.event.issue.pull_request.base.sha }}
            Head SHA: ${{ github.event.issue.pull_request.head.sha }}

            Comment from @${{ github.actor }}:
            ----
            ${{ github.event.comment.body }}
            ----

            Follow the comment instructions precisely and respond with actionable guidance tailored to this PR.
      - name: Run Codex (full review)
        id: codex_full_review
        if: steps.mode.outputs.mode == 'full-review'
        uses: openai/codex-action@v1
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          codex-args: --allowed-tools "mcp__github_inline_comment__create_inline_comment,Bash(gh issue view:*),Bash(gh search:*),Bash(gh issue list:*),Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*)"
          prompt: |
            You are Codex reviewing frontend code changes for the ZenML Dashboard (OSS) with git diffs available locally.

            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.issue.number }}
            BASE SHA: ${{ github.event.issue.pull_request.base.sha }}
            HEAD SHA: ${{ github.event.issue.pull_request.head.sha }}

            Triggering comment from @${{ github.actor }}:
            ----
            ${{ github.event.comment.body }}
            ----

            Context:
            - Fetch additional context via:
              * gh pr view ${{ github.event.issue.number }} --json title,body,author,headRefName,baseRefName,commits
              * gh pr diff ${{ github.event.issue.number }} --name-only
            - Follow CLAUDE.md, AGENTS.md, and README conventions.
            - This is a Vite + React SPA using TanStack Query, React Router, Tailwind CSS, and TypeScript.
            - UI components should come from @zenml-io/react-component-library (never lucide-react).

            Primary Review Goals:
            1) Verify the change intent, edge cases, and regression risk.
            2) Enforce code quality: readability, hooks discipline, Query hygiene, router best practices.
            3) Validate accessibility, performance, and data-loading patterns.
            4) Ensure intentional diffs—no dead code, accidental assets, or config drift.
            5) Flag security or compatibility issues across supported ZenML versions.

            Documentation & Testing:
            - Cross-check docs (README, CLAUDE.md, AGENTS.md) when user flows/components change.
            - Confirm env vars and OpenAPI types are updated where applicable.
            - Testing (keep concise—avoid verbose or generic suggestions):
              * Only suggest tests directly relevant to the specific changes in this PR
              * For UI changes, suggest 1-2 specific manual testing steps
              * Do NOT recommend comprehensive test suites or patterns unrelated to the PR scope

            Output Instructions:
            - Start with a summary of what the PR achieves.
            - Enumerate critical blockers with file paths/lines.
            - Provide minor suggestions and highlight strong work.
            - End with actionable next steps.
            - Use `gh pr comment` for inline issues if needed (permitted via codex-args).

  post-comment:
    name: Post Codex reply
    runs-on: ubuntu-latest
    needs: run-codex
    if: |
      needs.run-codex.result == 'success' &&
      needs.run-codex.outputs.final_message != ''
    permissions:
      issues: write
      pull-requests: write
    steps:
      - name: Reply with Codex output
        uses: actions/github-script@v7
        env:
          CODEX_FINAL_MESSAGE: ${{ needs.run-codex.outputs.final_message }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const body = process.env.CODEX_FINAL_MESSAGE;
            if (!body) {
              core.info('No Codex output to post.');
              return;
            }
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });
